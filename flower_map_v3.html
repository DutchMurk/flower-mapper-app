<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flower Location Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 100%;
            min-height: 400px;
            border-radius: 0.5rem;
        }
        .leaflet-popup-content-wrapper { 
            border-radius: 0.375rem;
        }
        .custom-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        .custom-toast.show {
            opacity: 1;
        }
        .custom-toast.success {
            background-color: #28a745;
        }
        .custom-toast.error {
            background-color: #dc3545;
        }
        .custom-toast.info {
            background-color: #17a2b8;
        }
        input[type="file"]::file-selector-button {
            margin-right: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            background-color: #FFF;
            color: #374151;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #F9FAFB;
        }
        #folderProcessingLogs {
            max-height: 100px; 
            overflow-y: auto;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        #folderProcessingLogs p {
            margin-bottom: 0.25rem;
        }
        .title-input {
            background-color: transparent;
            border: none;
            outline: none;
            box-shadow: none;
            text-align: center;
            width: 100%;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        .title-input:focus {
            ring-width: 0;
            box-shadow: none;
        }
        .scientific-name-input {
            font-size: 1.875rem; 
            line-height: 2.25rem;
            font-weight: 700; 
            color: #db2777; 
        }
        @media (min-width: 768px) { 
            .scientific-name-input {
                font-size: 2.25rem; 
                line-height: 2.5rem;
            }
        }
        .dutch-name-input {
            color: #4b5563; 
            margin-top: 0.25rem; 
            font-size: 1rem; 
            line-height: 1.5rem;
        }
        #mapContainerOuter { 
            position: relative;
        }
        #exampleImageOverlay {
            position: absolute;
            bottom: 10px; 
            left: 10px;   
            max-width: 25%;  
            max-height: 35%; 
            border: 2px solid white;
            border-radius: 0.375rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            z-index: 900; 
            display: none; 
        }
        .toggle-button-panel-visible {
            width: 100%; background-color: #e5e7eb; padding-top: 0.5rem; padding-bottom: 0.5rem;
            padding-left: 1rem; padding-right: 1rem; color: #374151; font-weight: 600;
            border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 0.875rem; flex-shrink: 0; transition: background-color 0.15s ease-in-out;
        }
        .toggle-button-panel-visible:hover { background-color: #d1d5db; }
        .toggle-button-panel-hidden {
            position: absolute; top: 3%; right: 3%; width: 32px; height: 32px;
            background-color: #e5e7eb; color: #374151; font-size: 1.5rem; font-weight: 700;
            line-height: 0.8; display: flex; align-items: center; justify-content: center;
            border-radius: 9999px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            z-index: 1001; transition: background-color 0.15s ease-in-out, transform 0.15s ease-in-out;
        }
         .toggle-button-panel-hidden:hover { background-color: #d1d5db; transform: scale(1.1); }
        
        .custom-cluster-icon {
            background-color: rgba(0, 120, 255, 0.6); 
            border: 2px solid rgba(0, 100, 220, 1);   
            border-radius: 50%;
            color: white;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 0 5px rgba(0,0,0,0.4);
        }

        #galleryModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); z-index: 10001; 
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out;
        }
        #galleryModal.show { opacity: 1; pointer-events: auto; }
        .gallery-content {
            position: relative; background-color: white; padding: 20px; border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center;
            max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column;
        }
        .gallery-image-container {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            overflow: hidden; margin-bottom: 5px; 
        }
        #galleryImage { max-width: 100%; max-height: 60vh; object-fit: contain; border-radius: 0.25rem; }
        .gallery-info {
            margin-bottom: 10px;
        }
        #galleryFilename { font-size: 0.9rem; color: #4A5568; margin-bottom: 2px; }
        #galleryCoordinates { font-size: 0.75rem; color: #718096; } 
        #galleryDate { font-size: 0.75rem; color: #718096; margin-top: 1px; } 
        .gallery-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .gallery-nav-button {
            background-color: #4A5568; color: white; border: none; padding: 8px 16px;
            border-radius: 0.375rem; cursor: pointer; font-size: 1.5rem;
        }
        .gallery-nav-button:hover { background-color: #2D3748; }
        .gallery-nav-button:disabled { background-color: #A0AEC0; cursor: not-allowed; }
        #galleryCloseButton {
            position: absolute; top: 8px; right: 8px; background: rgba(230, 230, 230, 0.8);
            border: 1px solid #b0b0b0; border-radius: 50%; width: 32px; height: 32px;
            font-size: 1.6rem; color: #333; cursor: pointer; z-index: 10;
            display: flex; align-items: center; justify-content: center; line-height: 1; padding: 0;
        }
         #galleryCloseButton:hover { background-color: rgba(200, 200, 200, 1); color: #000; }
        
        #speciesListContainer {
            max-height: 150px; 
            overflow-y: auto;
            border: 1px solid #e5e7eb; 
            border-radius: 0.375rem; 
            padding: 0.5rem;
            background-color: #f9fafb; 
        }
        .species-list-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        .species-list-item:last-child {
            border-bottom: none;
        }
        .species-list-item:hover {
            background-color: #eff6ff; 
        }
        .species-list-item.selected {
            background-color: #bfdbfe; 
            font-weight: 600;
        }
        #zoomLevelDisplay {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 8px;
            font-size: 0.8rem;
            border-radius: 0.25rem;
            z-index: 900; /* Below controls, above map */
            color: #333;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-4 text-center">
            <div>
                <input type="text" id="scientificNameInput" class="title-input scientific-name-input" placeholder="Scientific Flower Name">
            </div>
            <div>
                <input type="text" id="dutchNameInput" class="title-input dutch-name-input" placeholder="Dutch Flower Name">
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-6 mt-4">
            <div id="leftPanelContainer" class="flex flex-col lg:w-1/3 transition-all duration-300 ease-in-out">
                <button id="togglePanelButton">Hide Details Panel</button>
                <div id="panelContentWrapper" class="space-y-6 grow overflow-auto transition-opacity duration-300 ease-in-out mt-2">
                    <div class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 text-purple-600">1. Select Parent Folder</h2>
                        <p class="text-sm text-gray-600 mb-3">
                            Choose the main folder containing subfolders for each species (e.g., "Orchideeenfoto's").
                        </p>
                        <div>
                            <label for="parentFolderInput" class="block text-sm font-medium text-gray-700">Select Parent Folder:</label>
                            <input type="file" id="parentFolderInput" webkitdirectory directory
                                   class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer"/>
                        </div>
                    </div>
                    
                    <div id="speciesSelectionSection" class="bg-white p-6 rounded-lg shadow-lg" style="display: none;">
                        <h2 class="text-xl font-semibold mb-4 text-green-600">2. Select Species</h2>
                        <p class="text-sm text-gray-600 mb-3">
                            Click on a scientific name below to process its photos.
                        </p>
                        <div id="speciesListContainer">
                            {/* Initial content will be set by JS */}
                        </div>
                    </div>

                    <div id="processingInfoSection" class="bg-white p-6 rounded-lg shadow-lg" style="display: none;">
                        <h2 class="text-xl font-semibold mb-4 text-blue-600">3. Processing Results</h2>
                        <div id="folderProcessResult" class="mt-1 text-sm space-y-2">
                            <p id="imageCountText">Select a species to process.</p>
                            <div id="folderProcessingLogsContainer" style="display: none;">
                                 <h4 class="font-semibold text-gray-700">Processing Log:</h4>
                                 <div id="folderProcessingLogs"></div>
                            </div>
                        </div>
                         <p class="mt-4 text-xs text-gray-500">
                            Supports JPG, TIFF images with GPS EXIF data.
                        </p>
                    </div>

                    <div id="addedLocationsSection" class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold mb-3 text-pink-500">Added Locations (Current Species):</h3>
                        <div id="locationListContainer" class="max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-md border border-gray-200">
                            <ul id="locationList" class="list-disc list-inside space-y-1 text-sm">
                                <li id="noLocations" class="text-gray-500">No locations added yet.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="mapContainerOuter" class="lg:w-2/3 h-[500px] md:h-[600px] lg:h-[calc(100vh-12rem)] shadow-lg rounded-lg overflow-hidden transition-all duration-300 ease-in-out">
                <div id="map"></div>
                <img id="exampleImageOverlay" src="#" alt="Example flower image" />
                <div id="zoomLevelDisplay">Zoom: N/A</div> <!-- Zoom level display -->
            </div>
        </div>

        <footer class="mt-8 text-center text-sm text-gray-500">
            <p>&copy; <span id="currentYear"></span> Flower Mapper. Happy exploring!</p>
        </footer>
    </div>

    <!-- Gallery Modal -->
    <div id="galleryModal">
        <div class="gallery-content">
            <button id="galleryCloseButton">&times;</button>
            <div class="gallery-image-container">
                <img id="galleryImage" src="#" alt="Gallery image" />
            </div>
            <div class="gallery-info">
                <p id="galleryFilename">Filename.jpg</p>
                <p id="galleryCoordinates">Lat: N/A, Lon: N/A</p>
                <p id="galleryDate">(Datum niet beschikbaar)</p> 
            </div>
            <div class="gallery-controls">
                <button id="galleryPrevButton" class="gallery-nav-button">&larr;</button>
                <span id="galleryCounter">1 / 1</span>
                <button id="galleryNextButton" class="gallery-nav-button">&rarr;</button>
            </div>
        </div>
    </div>


    <div id="customToast" class="custom-toast">
        <span id="toastMessage"></span>
    </div>

    <script>
        window.addEventListener('load', function() { 
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            const map = L.map('map').setView([51.1657, 10.4515], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            let allOriginalPhotoLocations = []; 
            let activeClusterMarkers = []; 
            let subfolderSpeciesData = []; 

            const locationListElement = document.getElementById('locationList');
            const scientificNameInputElement = document.getElementById('scientificNameInput');
            const dutchNameInputElement = document.getElementById('dutchNameInput');
            const exampleImageOverlayElement = document.getElementById('exampleImageOverlay');
            const mapContainerOuterElement = document.getElementById('mapContainerOuter'); 
            const toastElement = document.getElementById('customToast');
            const toastMessageElement = document.getElementById('toastMessage');
            let toastTimeout;
            let currentExampleImageUrl = null; 

            const galleryModal = document.getElementById('galleryModal');
            const galleryImageElement = document.getElementById('galleryImage');
            const galleryFilenameElement = document.getElementById('galleryFilename');
            const galleryCoordinatesElement = document.getElementById('galleryCoordinates'); 
            const galleryDateElement = document.getElementById('galleryDate'); 
            const galleryPrevButton = document.getElementById('galleryPrevButton');
            const galleryNextButton = document.getElementById('galleryNextButton');
            const galleryCloseButton = document.getElementById('galleryCloseButton');
            const galleryCounterElement = document.getElementById('galleryCounter');
            let currentGalleryPhotosData = []; 
            let currentGalleryIndex = 0;
            let currentGalleryObjectUrls = []; 

            const parentFolderInputElement = document.getElementById('parentFolderInput'); 
            const speciesSelectionSection = document.getElementById('speciesSelectionSection');
            const speciesListContainer = document.getElementById('speciesListContainer');
            const processingInfoSection = document.getElementById('processingInfoSection');
            const imageCountTextElement = document.getElementById('imageCountText');
            const folderProcessingLogsContainer = document.getElementById('folderProcessingLogsContainer');
            const folderProcessingLogsElement = document.getElementById('folderProcessingLogs');
            
            const togglePanelButton = document.getElementById('togglePanelButton');
            const leftPanelContainer = document.getElementById('leftPanelContainer'); 
            const panelContentWrapper = document.getElementById('panelContentWrapper'); 
            let isPanelContentVisible = true; 
            
            const zoomLevelDisplayElement = document.getElementById('zoomLevelDisplay'); 


            function showToast(message, type = 'success', duration = 3000) {
                toastMessageElement.textContent = message;
                toastElement.className = 'custom-toast show ' + type;
                clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => {
                    toastElement.classList.remove('show');
                }, duration);
            }
            
            function resetUIForNewParentFolder() { 
                locationListElement.innerHTML = '<li id="noLocations" class="text-gray-500">No locations added yet.</li>';
                speciesListContainer.innerHTML = '<p id="noSpeciesFound" class="text-gray-500">Select a parent folder to see species.</p>'; 
                speciesSelectionSection.style.display = 'none';
                processingInfoSection.style.display = 'none';
                scientificNameInputElement.value = '';
                dutchNameInputElement.value = '';
                imageCountTextElement.textContent = 'Select a species to process.';
                folderProcessingLogsContainer.style.display = 'none';

                if (currentExampleImageUrl) {
                    URL.revokeObjectURL(currentExampleImageUrl);
                    currentExampleImageUrl = null;
                }
                exampleImageOverlayElement.style.display = 'none';
                exampleImageOverlayElement.src = "#";
                exampleImageOverlayElement.style.width = ''; 
                exampleImageOverlayElement.style.height = '';
                
                allOriginalPhotoLocations = [];
                subfolderSpeciesData = [];
                reclusterAndDisplay(); 
                closeGalleryModal(); 
            }
            
            function resetUIForNewSpeciesSelection() {
                locationListElement.innerHTML = '<li id="noLocations" class="text-gray-500">No locations added yet.</li>';
                imageCountTextElement.textContent = 'Processing...';
                folderProcessingLogsContainer.style.display = 'none';
                folderProcessingLogsElement.innerHTML = '';

                if (currentExampleImageUrl) {
                    URL.revokeObjectURL(currentExampleImageUrl);
                    currentExampleImageUrl = null;
                }
                exampleImageOverlayElement.style.display = 'none';
                exampleImageOverlayElement.src = "#";
                exampleImageOverlayElement.style.width = ''; 
                exampleImageOverlayElement.style.height = '';
                
                allOriginalPhotoLocations = [];
                reclusterAndDisplay(); 
                closeGalleryModal(); 
            }


            function createClusterIcon(count) {
                const size = count < 10 ? 30 : (count < 100 ? 35 : 40);
                return L.divIcon({
                    html: `<div style="line-height: ${size}px;">${count}</div>`,
                    className: 'custom-cluster-icon',
                    iconSize: [size, size]
                });
            }

            function getDynamicClusterThreshold() {
                const zoom = map.getZoom();
                // Adjusted thresholds for more aggressive clustering at lower zoom levels
                if (zoom <= 6) return 50000;  // 50km
                if (zoom <= 8) return 10000;  // 10km
                if (zoom <= 10) return 2000;   // 2km
                if (zoom <= 12) return 500;    // 500m
                if (zoom <= 14) return 100;    // 100m
                return 50; // 50m for higher zoom levels (was 25m)
            }
            
            function parseExifDate(dateString) {
                if (!dateString) return null;
                const parts = dateString.split(" ")[0].split(":");
                if (parts.length === 3) {
                    return new Date(parts[0], parts[1] - 1, parts[2]);
                }
                return null;
            }

            function openGalleryModal(photosData, startIndex = 0) { 
                if (!photosData || photosData.length === 0) return;
                
                currentGalleryObjectUrls.forEach(url => URL.revokeObjectURL(url));
                currentGalleryObjectUrls = [];

                const sortedPhotosData = [...photosData].sort((a, b) => {
                    const dateA = parseExifDate(a.date);
                    const dateB = parseExifDate(b.date);
                    if (dateA && dateB) {
                        return dateB - dateA; 
                    }
                    if (dateA) return -1; 
                    if (dateB) return 1;  
                    return 0; 
                });

                currentGalleryPhotosData = sortedPhotosData; 
                currentGalleryIndex = startIndex;
                displayGalleryImage();
                galleryModal.classList.add('show');
            }

            function closeGalleryModal() {
                galleryModal.classList.remove('show');
                currentGalleryObjectUrls.forEach(url => URL.revokeObjectURL(url));
                currentGalleryObjectUrls = [];
                galleryImageElement.src = "#"; 
            }
            
            function formatExifDateToDutch(dateString) {
                if (!dateString) return "(Datum niet beschikbaar)";
                const dateObj = parseExifDate(dateString);
                if (!dateObj) return "(Ongeldig datumformaat)";
                
                const day = dateObj.getDate(); 
                const month = dateObj.getMonth(); 
                const year = dateObj.getFullYear();

                const dutchMonths = ["jan", "feb", "mrt", "apr", "mei", "jun", "jul", "aug", "sep", "okt", "nov", "dec"];
                
                return `(${day} ${dutchMonths[month]} ${year})`; 
            }


            function displayGalleryImage() {
                if (currentGalleryPhotosData.length === 0 || currentGalleryIndex < 0 || currentGalleryIndex >= currentGalleryPhotosData.length) return;
                
                const currentPhotoData = currentGalleryPhotosData[currentGalleryIndex];
                const file = currentPhotoData.fileObject;
                const objectURL = URL.createObjectURL(file);
                currentGalleryObjectUrls.push(objectURL); 

                galleryImageElement.src = objectURL;
                galleryFilenameElement.textContent = currentPhotoData.desc; 
                galleryCoordinatesElement.textContent = `Lat: ${currentPhotoData.lat.toFixed(4)}, Lon: ${currentPhotoData.lon.toFixed(4)}`;
                galleryDateElement.textContent = formatExifDateToDutch(currentPhotoData.date); 
                galleryCounterElement.textContent = `${currentGalleryIndex + 1} / ${currentGalleryPhotosData.length}`;

                galleryPrevButton.disabled = currentGalleryIndex === 0;
                galleryNextButton.disabled = currentGalleryIndex === currentGalleryPhotosData.length - 1;
            }

            galleryPrevButton.addEventListener('click', () => {
                if (currentGalleryIndex > 0) { currentGalleryIndex--; displayGalleryImage(); }
            });
            galleryNextButton.addEventListener('click', () => {
                if (currentGalleryIndex < currentGalleryPhotosData.length - 1) { currentGalleryIndex++; displayGalleryImage(); }
            });
            galleryCloseButton.addEventListener('click', closeGalleryModal);
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && galleryModal.classList.contains('show')) closeGalleryModal();
            });

            function reclusterAndDisplay() {
                activeClusterMarkers.forEach(marker => map.removeLayer(marker));
                activeClusterMarkers = [];
                const noLocLi = document.getElementById('noLocations');

                if (allOriginalPhotoLocations.length === 0) {
                     if(noLocLi) noLocLi.style.display = 'list-item';
                    return;
                }
                 if(noLocLi) noLocLi.style.display = 'none';


                const currentThreshold = getDynamicClusterThreshold();
                let tempClusters = []; 

                allOriginalPhotoLocations.forEach(pointData => {
                    const pointLatLng = L.latLng(pointData.lat, pointData.lon);
                    let foundCluster = null;
                    for (let i = 0; i < tempClusters.length; i++) {
                        const cluster = tempClusters[i];
                        const clusterLatLng = L.latLng(cluster.lat, cluster.lon);
                        if (pointLatLng.distanceTo(clusterLatLng) < currentThreshold) {
                            foundCluster = cluster;
                            break;
                        }
                    }
                    if (foundCluster) {
                        foundCluster.points.push(pointData); 
                    } else {
                        tempClusters.push({ lat: pointData.lat, lon: pointData.lon, points: [pointData] });
                    }
                });

                tempClusters.forEach(cluster => {
                    let marker;
                    marker = L.marker([cluster.lat, cluster.lon], { icon: createClusterIcon(cluster.points.length) });
                    
                    marker.on('click', function() {
                        openGalleryModal(cluster.points, 0);
                    });

                    marker.addTo(map);
                    activeClusterMarkers.push(marker);
                    cluster.marker = marker; 
                });
                 window.currentClustersForDebug = tempClusters; 
            }
            
            function populateLocationList(photoData) { 
                const currentNoLocationsLi = document.getElementById('noLocations');
                if (currentNoLocationsLi) currentNoLocationsLi.style.display = 'none';
                
                const listItem = document.createElement('li');
                listItem.className = 'text-gray-700 hover:bg-pink-50 p-1 rounded cursor-pointer flex justify-between items-center';
                const textSpan = document.createElement('span');
                textSpan.textContent = `${photoData.desc} (Lat: ${photoData.lat.toFixed(2)}, Lon: ${photoData.lon.toFixed(2)})`;
                
                listItem.onclick = () => {
                    const currentClusters = window.currentClustersForDebug || [];
                    for (const cluster of currentClusters) {
                        const pointIndex = cluster.points.findIndex(p => p.desc === photoData.desc && p.lat === photoData.lat && p.lon === photoData.lon);
                        if (pointIndex > -1) {
                            openGalleryModal(cluster.points, pointIndex);
                            map.setView([cluster.lat, cluster.lon], Math.max(map.getZoom(), 15)); 
                            return;
                        }
                    }
                    map.setView([photoData.lat, photoData.lon], Math.max(map.getZoom(), 15));
                    openGalleryModal([photoData], 0); 
                };

                const removeButton = document.createElement('button');
                removeButton.innerHTML = '&times;';
                removeButton.className = 'ml-2 text-red-500 hover:text-red-700 font-bold text-xs px-1 rounded focus:outline-none';
                removeButton.title = 'Remove location';
                removeButton.onclick = (event) => {
                    event.stopPropagation();
                    const index = allOriginalPhotoLocations.findIndex(p => p.lat === photoData.lat && p.lon === photoData.lon && p.desc === photoData.desc);
                    if (index > -1) {
                        allOriginalPhotoLocations.splice(index, 1);
                    }
                    locationListElement.removeChild(listItem); 
                    reclusterAndDisplay(); 
                    
                    const currentNoLocationsLi = document.getElementById('noLocations');
                    if (locationListElement.children.length === 0 && currentNoLocationsLi) {
                         currentNoLocationsLi.style.display = 'list-item';
                    } else if (locationListElement.children.length === 0 && !currentNoLocationsLi) {
                        const newNoLocLi = document.createElement('li');
                        newNoLocLi.id = 'noLocations';
                        newNoLocLi.className = 'text-gray-500';
                        newNoLocLi.textContent = 'No locations added yet.';
                        locationListElement.appendChild(newNoLocLi);
                    }
                    showToast('Location removed & map updated.', 'info');
                };
                listItem.appendChild(textSpan);
                listItem.appendChild(removeButton);
                locationListElement.appendChild(listItem);
            }

            function convertDMSToDD(degrees, minutes, seconds, direction) {
                let dd = degrees + minutes / 60 + seconds / (60 * 60);
                if (direction === "S" || direction === "W") {
                    dd = dd * -1;
                }
                return dd;
            }

            function extractNamesFromFolderName(folderName) {
                let scientificName = folderName;
                let dutchName = '';
                const dutchNameMatch = folderName.match(/\(([^)]+)\)/);
                if (dutchNameMatch && dutchNameMatch[1]) {
                    dutchName = dutchNameMatch[1].trim();
                    scientificName = folderName.substring(0, dutchNameMatch.index).trim();
                }
                return { scientificName, dutchName };
            }

            function hidePanel() {
                if (!isPanelContentVisible) return; 

                isPanelContentVisible = false;
                panelContentWrapper.classList.add('hidden');
                leftPanelContainer.classList.remove('lg:w-1/3'); 
                leftPanelContainer.classList.add('lg:w-auto', 'w-auto', 'p-0', 'items-start'); 
                
                togglePanelButton.textContent = '-';
                togglePanelButton.className = 'toggle-button-panel-hidden';
                mapContainerOuterElement.appendChild(togglePanelButton); 

                mapContainerOuterElement.classList.add('lg:w-full');
                mapContainerOuterElement.classList.remove('lg:w-2/3');
                setTimeout(() => { map.invalidateSize(); }, 310); 
            }

            async function processSelectedSpecies(speciesData) {
                resetUIForNewSpeciesSelection();
                
                map.setView([47.5, 10.8], 5);
                updateZoomLevel(); 

                processingInfoSection.style.display = 'block';
                folderProcessingLogsContainer.style.display = 'block';
                folderProcessingLogsElement.innerHTML = '';

                scientificNameInputElement.value = speciesData.scientificName;
                dutchNameInputElement.value = speciesData.dutchName || "N/A";

                let exampleImageFile = null;
                let photosWithGPSCount = 0;
                const promises = [];

                for (const file of speciesData.filesInSubfolder) {
                     if (file.name.toLowerCase() === 'example.jpg') {
                        exampleImageFile = file;
                    }
                    if (['image/jpeg', 'image/tiff'].includes(file.type) || ['.jpg', '.jpeg', '.tif', '.tiff'].includes(file.name.substring(file.name.lastIndexOf('.')).toLowerCase())) {
                        const logEntry = document.createElement('p');
                        logEntry.textContent = `Processing for EXIF: ${file.name}...`;
                        folderProcessingLogsElement.appendChild(logEntry);
                        folderProcessingLogsElement.scrollTop = folderProcessingLogsElement.scrollHeight;

                        promises.push(new Promise(async (resolveFile) => {
                            try {
                                const exifData = await new Promise((resolve, reject) => {
                                    EXIF.getData(file, function() { 
                                        const allTags = EXIF.getAllTags(this);
                                        if (Object.keys(allTags).length > 0) resolve(allTags);
                                        else reject(new Error("No EXIF data found."));
                                    });
                                    setTimeout(() => reject(new Error("EXIF.getData timed out")), 3000);
                                });
                                const latData = exifData.GPSLatitude;
                                const lonData = exifData.GPSLongitude;
                                const latRef = exifData.GPSLatitudeRef;
                                const lonRef = exifData.GPSLongitudeRef;
                                const dateTaken = exifData.DateTimeOriginal || exifData.DateTime; 

                                if (latData && lonData && latRef && lonRef) {
                                    const latitude = convertDMSToDD(latData[0], latData[1], latData[2], latRef);
                                    const longitude = convertDMSToDD(lonData[0], lonData[1], lonData[2], lonRef);
                                    const photoData = { lat: latitude, lon: longitude, desc: file.name, fileObject: file, date: dateTaken }; 
                                    allOriginalPhotoLocations.push(photoData);
                                    populateLocationList(photoData); 
                                    photosWithGPSCount++;
                                    logEntry.innerHTML += ` <span class="text-green-600">GPS found - Stored.</span>`;
                                } else {
                                    logEntry.innerHTML += ` <span class="text-gray-500">No GPS data.</span>`;
                                }
                            } catch (error) {
                                console.error("Error EXIF " + file.name + ":", error);
                                logEntry.innerHTML += ` <span class="text-red-600">Error (${error.message}).</span>`;
                            }
                            resolveFile();
                        }));
                    }
                }

                if (exampleImageFile) {
                    currentExampleImageUrl = URL.createObjectURL(exampleImageFile);
                    const tempImg = new Image();
                    tempImg.onload = function() {
                        const maxAllowedWidth = mapContainerOuterElement.clientWidth * 0.20; 
                        const maxAllowedHeight = mapContainerOuterElement.clientHeight * 0.30; 
                        let newWidth = tempImg.naturalWidth;
                        let newHeight = tempImg.naturalHeight;
                        if (newWidth > maxAllowedWidth) {
                            newHeight = (maxAllowedWidth / newWidth) * newHeight;
                            newWidth = maxAllowedWidth;
                        }
                        if (newHeight > maxAllowedHeight) {
                            newWidth = (maxAllowedHeight / newHeight) * newWidth;
                            newHeight = maxAllowedHeight;
                        }
                        exampleImageOverlayElement.style.width = newWidth + 'px';
                        exampleImageOverlayElement.style.height = newHeight + 'px';
                        exampleImageOverlayElement.src = currentExampleImageUrl;
                        exampleImageOverlayElement.style.display = 'block';
                    }
                    tempImg.src = currentExampleImageUrl;
                    showToast('"example.jpg" found and displayed.', 'info');
                } else {
                    exampleImageOverlayElement.style.display = 'none';
                    exampleImageOverlayElement.style.width = ''; 
                    exampleImageOverlayElement.style.height = '';
                    showToast('"example.jpg" not found in this species folder.', 'info');
                }
                
                await Promise.all(promises); 
                reclusterAndDisplay(); 
                imageCountTextElement.innerHTML = `Processed <strong class="text-green-700">${speciesData.filesInSubfolder.length}</strong> files in species folder. 
                                               <strong class="text-pink-600">${photosWithGPSCount}</strong> photo(s) with GPS added.`;
                showToast(`Processing complete for ${speciesData.scientificName}. ${photosWithGPSCount} photos with GPS.`, 'success', 5000);
                
                hidePanel();
            }


            parentFolderInputElement.addEventListener('change', function(event) {
                const files = event.target.files;
                if (!files || files.length === 0) {
                    showToast('No parent folder selected or folder is empty.', 'info');
                    return;
                }
                
                resetUIForNewParentFolder();
                const detectedSubfolders = new Map(); 

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const relativePath = file.webkitRelativePath; 
                    
                    const pathParts = relativePath.split('/');
                    if (pathParts.length > 1) { 
                        const actualSubfolderName = pathParts[pathParts.length - 2]; 
                        if (pathParts[0] !== actualSubfolderName && pathParts.length > 2) { 
                        }
                        if (pathParts.length > 2) { 
                            const speciesSubfolderName = pathParts[1];
                            if (!detectedSubfolders.has(speciesSubfolderName)) {
                                detectedSubfolders.set(speciesSubfolderName, { filesInSubfolder: [] });
                            }
                            detectedSubfolders.get(speciesSubfolderName).filesInSubfolder.push(file);
                        } else {
                             console.log(`File ${file.name} (path: ${relativePath}) is not in a recognized species subfolder structure.`);
                        }
                    }
                }

                subfolderSpeciesData = []; 
                detectedSubfolders.forEach((data, originalSubfolderName) => {
                    subfolderSpeciesData.push({
                        ...extractNamesFromFolderName(originalSubfolderName), 
                        originalSubfolderName: originalSubfolderName,
                        filesInSubfolder: data.filesInSubfolder
                    });
                });

                subfolderSpeciesData.sort((a, b) => a.scientificName.localeCompare(b.scientificName));

                speciesListContainer.innerHTML = ''; 
                if (subfolderSpeciesData.length > 0) {
                    speciesSelectionSection.style.display = 'block';
                    subfolderSpeciesData.forEach((species, index) => {
                        const speciesDiv = document.createElement('div');
                        speciesDiv.className = 'species-list-item';
                        speciesDiv.textContent = `${species.scientificName}${species.dutchName ? ` (${species.dutchName})` : ''}`;
                        speciesDiv.dataset.speciesIndex = index; 
                        speciesDiv.onclick = function() {
                            const currentlySelected = speciesListContainer.querySelector('.species-list-item.selected');
                            if (currentlySelected) {
                                currentlySelected.classList.remove('selected');
                            }
                            this.classList.add('selected');
                            const selectedSpeciesData = subfolderSpeciesData[parseInt(this.dataset.speciesIndex)];
                            processSelectedSpecies(selectedSpeciesData);
                        };
                        speciesListContainer.appendChild(speciesDiv);
                    });
                } else {
                    speciesSelectionSection.style.display = 'block'; 
                    const noSpeciesP = document.createElement('p');
                    noSpeciesP.id = 'noSpeciesFound'; 
                    noSpeciesP.className = 'text-gray-500';
                    noSpeciesP.textContent = 'No species subfolders found in the selected parent folder.';
                    speciesListContainer.appendChild(noSpeciesP);
                }
                parentFolderInputElement.value = ''; 
            });
            
            // Function to update zoom level display
            function updateZoomLevel() {
                if (zoomLevelDisplayElement) {
                    zoomLevelDisplayElement.textContent = 'Zoom: ' + map.getZoom();
                }
            }

            map.on('zoomend', function() {
                reclusterAndDisplay();
                updateZoomLevel(); // Update zoom display
            });
            map.on('moveend', function() {
                reclusterAndDisplay();
                // No need to update zoom on moveend unless zoom also changed
            });
            updateZoomLevel(); // Initial zoom level display


            togglePanelButton.className = 'toggle-button-panel-visible';

            togglePanelButton.addEventListener('click', () => {
                isPanelContentVisible = !isPanelContentVisible;
                if (isPanelContentVisible) { 
                    panelContentWrapper.classList.remove('hidden');
                    leftPanelContainer.classList.remove('lg:w-auto', 'w-auto', 'p-0', 'items-start');
                    leftPanelContainer.classList.add('lg:w-1/3'); 
                    togglePanelButton.textContent = 'Hide Details Panel';
                    togglePanelButton.className = 'toggle-button-panel-visible';
                    leftPanelContainer.insertBefore(togglePanelButton, panelContentWrapper);
                    mapContainerOuterElement.classList.remove('lg:w-full');
                    mapContainerOuterElement.classList.add('lg:w-2/3');
                } else { 
                    panelContentWrapper.classList.add('hidden');
                    leftPanelContainer.classList.remove('lg:w-1/3'); 
                    leftPanelContainer.classList.add('lg:w-auto', 'w-auto', 'p-0', 'items-start'); 
                    togglePanelButton.textContent = '-';
                    togglePanelButton.className = 'toggle-button-panel-hidden';
                    mapContainerOuterElement.appendChild(togglePanelButton); 
                    mapContainerOuterElement.classList.add('lg:w-full');
                    mapContainerOuterElement.classList.remove('lg:w-2/3');
                }
                setTimeout(() => { map.invalidateSize(); }, 310); 
            });

            const mapElement = document.getElementById('map'); 
            const resizeObserver = new ResizeObserver(() => { map.invalidateSize(); });
            resizeObserver.observe(mapContainerOuterElement); 
        }); 
    </script>
</body>
</html>
