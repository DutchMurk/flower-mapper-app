<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flower Location Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #map {
            height: 100%;
            min-height: 400px;
            border-radius: 0.5rem;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.375rem;
        }
        .custom-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        .custom-toast.show {
            opacity: 1;
        }
        .custom-toast.success {
            background-color: #28a745;
        }
        .custom-toast.error {
            background-color: #dc3545;
        }
        .custom-toast.info {
            background-color: #17a2b8;
        }
        input[type="file"]::file-selector-button {
            margin-right: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            background-color: #FFF;
            color: #374151;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #F9FAFB;
        }
        #folderProcessingLogs {
            max-height: 150px;
            overflow-y: auto;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        #folderProcessingLogs p {
            margin-bottom: 0.25rem;
        }
        .title-input {
            background-color: transparent;
            border: none;
            outline: none;
            box-shadow: none;
            text-align: center;
            width: 100%;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        .title-input:focus {
            ring-width: 0;
            box-shadow: none;
        }
        .scientific-name-input {
            font-size: 1.875rem; 
            line-height: 2.25rem;
            font-weight: 700; 
            color: #db2777; 
        }
        @media (min-width: 768px) { 
            .scientific-name-input {
                font-size: 2.25rem; 
                line-height: 2.5rem;
            }
        }
        .dutch-name-input {
            color: #4b5563; 
            margin-top: 0.25rem; 
            font-size: 1rem; 
            line-height: 1.5rem;
        }
        #mapContainerOuter { 
            position: relative;
        }
        #exampleImageOverlay {
            position: absolute;
            bottom: 10px; 
            left: 10px;   
            max-width: 25%;  
            max-height: 35%; 
            border: 2px solid white;
            border-radius: 0.375rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            z-index: 900; 
            display: none; 
        }
        .toggle-button-panel-visible {
            width: 100%; background-color: #e5e7eb; padding-top: 0.5rem; padding-bottom: 0.5rem;
            padding-left: 1rem; padding-right: 1rem; color: #374151; font-weight: 600;
            border-radius: 0.375rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 0.875rem; flex-shrink: 0; transition: background-color 0.15s ease-in-out;
        }
        .toggle-button-panel-visible:hover { background-color: #d1d5db; }
        .toggle-button-panel-hidden {
            position: absolute; top: 3%; right: 3%; width: 32px; height: 32px;
            background-color: #e5e7eb; color: #374151; font-size: 1.5rem; font-weight: 700;
            line-height: 0.8; display: flex; align-items: center; justify-content: center;
            border-radius: 9999px; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            z-index: 1001; transition: background-color 0.15s ease-in-out, transform 0.15s ease-in-out;
        }
         .toggle-button-panel-hidden:hover { background-color: #d1d5db; transform: scale(1.1); }
        
        .custom-cluster-icon {
            background-color: rgba(0, 120, 255, 0.6); 
            border: 2px solid rgba(0, 100, 220, 1);   
            border-radius: 50%;
            color: white;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 0 5px rgba(0,0,0,0.4);
        }

        /* Gallery Modal Styles */
        #galleryModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 10001; /* Above toast */
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        #galleryModal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .gallery-content {
            position: relative; /* Added for positioning context of the close button */
            background-color: white;
            padding: 20px;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .gallery-image-container {
            flex-grow: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
            margin-bottom: 15px;
        }
        #galleryImage {
            max-width: 100%;
            max-height: 70vh; 
            object-fit: contain;
            border-radius: 0.25rem;
        }
        .gallery-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        .gallery-nav-button {
            background-color: #4A5568; 
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 1.5rem;
        }
        .gallery-nav-button:hover {
            background-color: #2D3748; 
        }
        .gallery-nav-button:disabled {
            background-color: #A0AEC0; 
            cursor: not-allowed;
        }
        #galleryFilename {
            font-size: 0.9rem;
            color: #4A5568;
        }
        #galleryCloseButton {
            position: absolute;
            top: 8px; /* Adjusted for better placement within padding */
            right: 8px; /* Adjusted for better placement within padding */
            background: rgba(230, 230, 230, 0.8); /* Light background for visibility */
            border: 1px solid #b0b0b0;
            border-radius: 50%; /* Circular button */
            width: 32px; /* Explicit size */
            height: 32px; /* Explicit size */
            font-size: 1.6rem; /* Adjusted for new size */
            color: #333; /* Darker color for the '×' */
            cursor: pointer;
            z-index: 10; /* Ensure it's above other content within the modal */
            display: flex; 
            align-items: center;
            justify-content: center;
            line-height: 1; /* For better centering of '×' */
            padding: 0; /* Remove default button padding if any */
        }
         #galleryCloseButton:hover {
            background-color: rgba(200, 200, 200, 1);
            color: #000;
        }
        .popup-view-gallery-button {
            background-color: #3b82f6; 
            color: white;
            padding: 5px 10px;
            border-radius: 0.25rem;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 5px;
            display: inline-block;
        }
        .popup-view-gallery-button:hover {
            background-color: #2563eb; 
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-4 text-center">
            <div>
                <input type="text" id="scientificNameInput" class="title-input scientific-name-input" placeholder="Scientific Flower Name">
            </div>
            <div>
                <input type="text" id="dutchNameInput" class="title-input dutch-name-input" placeholder="Dutch Flower Name">
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-6 mt-4">
            <div id="leftPanelContainer" class="flex flex-col lg:w-1/3 transition-all duration-300 ease-in-out">
                <button id="togglePanelButton">Hide Details Panel</button>
                <div id="panelContentWrapper" class="space-y-6 grow overflow-auto transition-opacity duration-300 ease-in-out mt-2">
                    <div id="processFolderSection" class="bg-white p-6 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold mb-4 text-green-600">Process Image Folder</h2>
                        <p class="text-sm text-gray-600 mb-3">
                            Select a local folder. GPS data will be plotted & dynamically clustered. Folder name for flower names. "example.jpg" shown on map.
                        </p>
                        <div>
                            <label for="folderInput" class="block text-sm font-medium text-gray-700">Select Image Folder:</label>
                            <input type="file" id="folderInput" webkitdirectory directory multiple
                                   class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer"/>
                        </div>
                        <div id="folderProcessResult" class="mt-4 text-sm space-y-2">
                            <p id="imageCountText">No folder selected yet.</p>
                            <div id="folderProcessingLogsContainer" style="display: none;">
                                 <h4 class="font-semibold text-gray-700">Processing Log:</h4>
                                 <div id="folderProcessingLogs"></div>
                            </div>
                        </div>
                         <p class="mt-4 text-xs text-gray-500">
                            Supports JPG, TIFF images with GPS EXIF data.
                        </p>
                    </div>

                    <div id="addedLocationsSection" class="bg-white p-6 rounded-lg shadow-lg">
                        <h3 class="text-lg font-semibold mb-3 text-pink-500">Added Locations:</h3>
                        <div id="locationListContainer" class="max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-md border border-gray-200">
                            <ul id="locationList" class="list-disc list-inside space-y-1 text-sm">
                                <li id="noLocations" class="text-gray-500">No locations added yet.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="mapContainerOuter" class="lg:w-2/3 h-[500px] md:h-[600px] lg:h-[calc(100vh-12rem)] shadow-lg rounded-lg overflow-hidden transition-all duration-300 ease-in-out">
                <div id="map"></div>
                <img id="exampleImageOverlay" src="#" alt="Example flower image" />
            </div>
        </div>

        <footer class="mt-8 text-center text-sm text-gray-500">
            <p>&copy; <span id="currentYear"></span> Flower Mapper. Happy exploring!</p>
        </footer>
    </div>

    <div id="galleryModal">
        <div class="gallery-content">
            <button id="galleryCloseButton">&times;</button>
            <div class="gallery-image-container">
                <img id="galleryImage" src="#" alt="Gallery image" />
            </div>
            <p id="galleryFilename">Filename.jpg</p>
            <div class="gallery-controls">
                <button id="galleryPrevButton" class="gallery-nav-button">&larr;</button>
                <span id="galleryCounter">1 / 1</span>
                <button id="galleryNextButton" class="gallery-nav-button">&rarr;</button>
            </div>
        </div>
    </div>


    <div id="customToast" class="custom-toast">
        <span id="toastMessage"></span>
    </div>

    <script>
        window.addEventListener('load', function() { 
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            const map = L.map('map').setView([51.1657, 10.4515], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            let allOriginalPhotoLocations = []; 
            let activeClusterMarkers = []; 

            const locationListElement = document.getElementById('locationList');
            const scientificNameInputElement = document.getElementById('scientificNameInput');
            const dutchNameInputElement = document.getElementById('dutchNameInput');
            const exampleImageOverlayElement = document.getElementById('exampleImageOverlay');
            const mapContainerOuterElement = document.getElementById('mapContainerOuter'); 
            const toastElement = document.getElementById('customToast');
            const toastMessageElement = document.getElementById('toastMessage');
            let toastTimeout;
            let currentExampleImageUrl = null; 

            // Gallery Modal Elements
            const galleryModal = document.getElementById('galleryModal');
            const galleryImageElement = document.getElementById('galleryImage');
            const galleryFilenameElement = document.getElementById('galleryFilename');
            const galleryPrevButton = document.getElementById('galleryPrevButton');
            const galleryNextButton = document.getElementById('galleryNextButton');
            const galleryCloseButton = document.getElementById('galleryCloseButton');
            const galleryCounterElement = document.getElementById('galleryCounter');

            let currentGalleryFiles = [];
            let currentGalleryIndex = 0;
            let currentGalleryObjectUrls = []; 

            function showToast(message, type = 'success', duration = 3000) {
                toastMessageElement.textContent = message;
                toastElement.className = 'custom-toast show ' + type;
                clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => {
                    toastElement.classList.remove('show');
                }, duration);
            }
            
            function clearAllUIData() { 
                locationListElement.innerHTML = ''; 
                const newNoLocationsLi = document.createElement('li');
                newNoLocationsLi.id = 'noLocations';
                newNoLocationsLi.className = 'text-gray-500';
                newNoLocationsLi.textContent = 'No locations added yet.';
                locationListElement.appendChild(newNoLocationsLi);

                if (currentExampleImageUrl) {
                    URL.revokeObjectURL(currentExampleImageUrl);
                    currentExampleImageUrl = null;
                }
                exampleImageOverlayElement.style.display = 'none';
                exampleImageOverlayElement.src = "#";
                exampleImageOverlayElement.style.width = ''; 
                exampleImageOverlayElement.style.height = '';
                
                allOriginalPhotoLocations = [];
                reclusterAndDisplay(); 
                closeGalleryModal(); 
            }

            function createClusterIcon(count) {
                const size = count < 10 ? 30 : (count < 100 ? 35 : 40);
                return L.divIcon({
                    html: `<div style="line-height: ${size}px;">${count}</div>`,
                    className: 'custom-cluster-icon',
                    iconSize: [size, size]
                });
            }

            function getDynamicClusterThreshold() {
                const zoom = map.getZoom();
                if (zoom <= 5) return 10000; 
                if (zoom <= 7) return 2000;
                if (zoom <= 9) return 500;
                if (zoom <= 11) return 200;
                if (zoom <= 13) return 100;
                if (zoom <= 15) return 50;
                return 25; 
            }
            
            function openGalleryModal(files, startIndex = 0) {
                if (!files || files.length === 0) return;
                
                currentGalleryObjectUrls.forEach(url => URL.revokeObjectURL(url));
                currentGalleryObjectUrls = [];

                currentGalleryFiles = files.map(f => f.fileObject); 
                currentGalleryIndex = startIndex;
                displayGalleryImage();
                galleryModal.classList.add('show');
            }

            function closeGalleryModal() {
                galleryModal.classList.remove('show');
                currentGalleryObjectUrls.forEach(url => URL.revokeObjectURL(url));
                currentGalleryObjectUrls = [];
                galleryImageElement.src = "#"; 
            }

            function displayGalleryImage() {
                if (currentGalleryFiles.length === 0) return;
                const file = currentGalleryFiles[currentGalleryIndex];
                const objectURL = URL.createObjectURL(file);
                currentGalleryObjectUrls.push(objectURL); 

                galleryImageElement.src = objectURL;
                galleryFilenameElement.textContent = file.name;
                galleryCounterElement.textContent = `${currentGalleryIndex + 1} / ${currentGalleryFiles.length}`;

                galleryPrevButton.disabled = currentGalleryIndex === 0;
                galleryNextButton.disabled = currentGalleryIndex === currentGalleryFiles.length - 1;
            }

            galleryPrevButton.addEventListener('click', () => {
                if (currentGalleryIndex > 0) {
                    currentGalleryIndex--;
                    displayGalleryImage();
                }
            });

            galleryNextButton.addEventListener('click', () => {
                if (currentGalleryIndex < currentGalleryFiles.length - 1) {
                    currentGalleryIndex++;
                    displayGalleryImage();
                }
            });
            galleryCloseButton.addEventListener('click', closeGalleryModal);
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && galleryModal.classList.contains('show')) {
                    closeGalleryModal();
                }
            });


            function reclusterAndDisplay() {
                activeClusterMarkers.forEach(marker => map.removeLayer(marker));
                activeClusterMarkers = [];

                if (allOriginalPhotoLocations.length === 0) {
                     const noLocLi = document.getElementById('noLocations');
                     if(noLocLi) noLocLi.style.display = 'list-item';
                    return;
                }

                const currentThreshold = getDynamicClusterThreshold();
                let tempClusters = []; 

                allOriginalPhotoLocations.forEach(pointData => {
                    const pointLatLng = L.latLng(pointData.lat, pointData.lon);
                    let foundCluster = null;
                    for (let i = 0; i < tempClusters.length; i++) {
                        const cluster = tempClusters[i];
                        const clusterLatLng = L.latLng(cluster.lat, cluster.lon);
                        if (pointLatLng.distanceTo(clusterLatLng) < currentThreshold) {
                            foundCluster = cluster;
                            break;
                        }
                    }

                    if (foundCluster) {
                        foundCluster.points.push(pointData); 
                    } else {
                        tempClusters.push({
                            lat: pointData.lat,
                            lon: pointData.lon,
                            points: [pointData] 
                        });
                    }
                });

                tempClusters.forEach(cluster => {
                    let marker;
                    let popupContent = '';
                    
                    const viewButton = document.createElement('button');
                    viewButton.className = 'popup-view-gallery-button';
                    viewButton.onclick = () => openGalleryModal(cluster.points, 0);

                    if (cluster.points.length === 1) {
                        const point = cluster.points[0];
                        marker = L.marker([point.lat, point.lon]);
                        popupContent = `<b>${point.desc}</b><br>Lat: ${point.lat.toFixed(4)}, Lon: ${point.lon.toFixed(4)}<br>`;
                        viewButton.textContent = 'View Image';
                    } else {
                        marker = L.marker([cluster.lat, cluster.lon], { icon: createClusterIcon(cluster.points.length) });
                        popupContent = `<b>Cluster (${cluster.points.length} photos)</b><br>Approx. Lat: ${cluster.lat.toFixed(4)}, Lon: ${cluster.lon.toFixed(4)}<br>`;
                        viewButton.textContent = 'View Gallery';
                    }
                    
                    const popupDiv = document.createElement('div');
                    popupDiv.innerHTML = popupContent;
                    popupDiv.appendChild(viewButton);

                    marker.bindPopup(popupDiv);
                    marker.addTo(map);
                    activeClusterMarkers.push(marker);
                    cluster.marker = marker; 
                });
                 window.currentClustersForDebug = tempClusters; 
            }
            
            function populateLocationList(photoData) { 
                const currentNoLocationsLi = document.getElementById('noLocations');
                if (currentNoLocationsLi) currentNoLocationsLi.style.display = 'none';
                
                const listItem = document.createElement('li');
                listItem.className = 'text-gray-700 hover:bg-pink-50 p-1 rounded cursor-pointer flex justify-between items-center';
                const textSpan = document.createElement('span');
                textSpan.textContent = `${photoData.desc} (Lat: ${photoData.lat.toFixed(2)}, Lon: ${photoData.lon.toFixed(2)})`;
                
                listItem.onclick = () => {
                    const currentClusters = window.currentClustersForDebug || [];
                    for (const cluster of currentClusters) {
                        const pointIndex = cluster.points.findIndex(p => p.desc === photoData.desc && p.lat === photoData.lat && p.lon === photoData.lon);
                        if (pointIndex > -1) {
                            if (cluster.marker) {
                                map.setView([cluster.lat, cluster.lon], Math.max(map.getZoom(), 15));
                                cluster.marker.openPopup(); 
                            }
                            return;
                        }
                    }
                    map.setView([photoData.lat, photoData.lon], Math.max(map.getZoom(), 15));
                    openGalleryModal([photoData], 0); 
                };

                const removeButton = document.createElement('button');
                removeButton.innerHTML = '&times;';
                removeButton.className = 'ml-2 text-red-500 hover:text-red-700 font-bold text-xs px-1 rounded focus:outline-none';
                removeButton.title = 'Remove location';
                removeButton.onclick = (event) => {
                    event.stopPropagation();
                    const index = allOriginalPhotoLocations.findIndex(p => p.lat === photoData.lat && p.lon === photoData.lon && p.desc === photoData.desc);
                    if (index > -1) {
                        allOriginalPhotoLocations.splice(index, 1);
                    }
                    locationListElement.removeChild(listItem); 
                    reclusterAndDisplay(); 
                    
                    const currentNoLocationsLi = document.getElementById('noLocations');
                    if (locationListElement.children.length === 0 && currentNoLocationsLi) {
                         currentNoLocationsLi.style.display = 'list-item';
                    } else if (locationListElement.children.length === 0 && !currentNoLocationsLi) {
                        const newNoLocLi = document.createElement('li');
                        newNoLocLi.id = 'noLocations';
                        newNoLocLi.className = 'text-gray-500';
                        newNoLocLi.textContent = 'No locations added yet.';
                        locationListElement.appendChild(newNoLocLi);
                    }
                    showToast('Location removed & map updated.', 'info');
                };
                listItem.appendChild(textSpan);
                listItem.appendChild(removeButton);
                locationListElement.appendChild(listItem);
            }


            const folderInputElement = document.getElementById('folderInput');
            const imageCountTextElement = document.getElementById('imageCountText');
            const folderProcessingLogsContainer = document.getElementById('folderProcessingLogsContainer');
            const folderProcessingLogsElement = document.getElementById('folderProcessingLogs');

            function convertDMSToDD(degrees, minutes, seconds, direction) {
                let dd = degrees + minutes / 60 + seconds / (60 * 60);
                if (direction === "S" || direction === "W") {
                    dd = dd * -1;
                }
                return dd;
            }

            function extractNamesFromFolderName(folderName) {
                let scientificName = folderName;
                let dutchName = '';
                const dutchNameMatch = folderName.match(/\(([^)]+)\)/);
                if (dutchNameMatch && dutchNameMatch[1]) {
                    dutchName = dutchNameMatch[1].trim();
                    scientificName = folderName.substring(0, dutchNameMatch.index).trim();
                }
                return { scientificName, dutchName };
            }

            folderInputElement.addEventListener('change', async function(event) {
                const files = event.target.files;
                if (!files || files.length === 0) {
                    imageCountTextElement.textContent = 'No folder or files selected.';
                    folderProcessingLogsContainer.style.display = 'none';
                    showToast('No folder selected or folder is empty.', 'info');
                    return;
                }
                
                clearAllUIData(); 

                let selectedFolderName = "Unknown Folder";
                if (files[0] && files[0].webkitRelativePath) {
                    const pathParts = files[0].webkitRelativePath.split('/');
                    if (pathParts.length > 1) {
                        selectedFolderName = pathParts[0]; 
                    }
                }
                
                const { scientificName, dutchName } = extractNamesFromFolderName(selectedFolderName);
                scientificNameInputElement.value = scientificName;
                dutchNameInputElement.value = dutchName || "Not found in folder name"; 

                if (dutchName) {
                    showToast(`Folder names set: ${scientificName} (${dutchName})`, 'info', 4000);
                } else if (scientificName !== "Unknown Folder") {
                     showToast(`Folder name set: ${scientificName}`, 'info', 4000);
                }

                folderProcessingLogsElement.innerHTML = '';
                folderProcessingLogsContainer.style.display = 'block';
                let imageFileCount = 0;
                let exampleImageFile = null;
                let photosWithGPSCount = 0;
                const promises = [];

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    if (file.name.toLowerCase() === 'example.jpg') {
                        exampleImageFile = file;
                    }

                    if (['image/jpeg', 'image/tiff'].includes(file.type) || ['.jpg', '.jpeg', '.tif', '.tiff'].includes(file.name.substring(file.name.lastIndexOf('.')).toLowerCase())) {
                        imageFileCount++;
                        const logEntry = document.createElement('p');
                        logEntry.textContent = `Processing for EXIF: ${file.name}...`;
                        folderProcessingLogsElement.appendChild(logEntry);
                        folderProcessingLogsElement.scrollTop = folderProcessingLogsElement.scrollHeight;

                        promises.push(new Promise(async (resolveFile) => {
                            try {
                                const exifData = await new Promise((resolve, reject) => {
                                    EXIF.getData(file, function() { 
                                        const allTags = EXIF.getAllTags(this);
                                        if (Object.keys(allTags).length > 0) resolve(allTags);
                                        else reject(new Error("No EXIF data found."));
                                    });
                                    setTimeout(() => reject(new Error("EXIF.getData timed out")), 3000);
                                });
                                const latData = exifData.GPSLatitude;
                                const lonData = exifData.GPSLongitude;
                                const latRef = exifData.GPSLatitudeRef;
                                const lonRef = exifData.GPSLongitudeRef;
                                if (latData && lonData && latRef && lonRef) {
                                    const latitude = convertDMSToDD(latData[0], latData[1], latData[2], latRef);
                                    const longitude = convertDMSToDD(lonData[0], lonData[1], lonData[2], lonRef);
                                    
                                    const photoData = { lat: latitude, lon: longitude, desc: file.name, fileObject: file }; 
                                    allOriginalPhotoLocations.push(photoData);
                                    populateLocationList(photoData); 
                                    photosWithGPSCount++;
                                    logEntry.innerHTML += ` <span class="text-green-600">GPS found - Stored.</span>`;
                                } else {
                                    logEntry.innerHTML += ` <span class="text-gray-500">No GPS data.</span>`;
                                }
                            } catch (error) {
                                console.error("Error EXIF " + file.name + ":", error);
                                logEntry.innerHTML += ` <span class="text-red-600">Error (${error.message}).</span>`;
                            }
                            resolveFile();
                        }));
                    }
                }

                if (exampleImageFile) {
                    currentExampleImageUrl = URL.createObjectURL(exampleImageFile);
                    const tempImg = new Image();
                    tempImg.onload = function() {
                        const maxAllowedWidth = mapContainerOuterElement.clientWidth * 0.20; 
                        const maxAllowedHeight = mapContainerOuterElement.clientHeight * 0.30; 
                        let newWidth = tempImg.naturalWidth;
                        let newHeight = tempImg.naturalHeight;
                        if (newWidth > maxAllowedWidth) {
                            newHeight = (maxAllowedWidth / newWidth) * newHeight;
                            newWidth = maxAllowedWidth;
                        }
                        if (newHeight > maxAllowedHeight) {
                            newWidth = (maxAllowedHeight / newHeight) * newWidth;
                            newHeight = maxAllowedHeight;
                        }
                        exampleImageOverlayElement.style.width = newWidth + 'px';
                        exampleImageOverlayElement.style.height = newHeight + 'px';
                        exampleImageOverlayElement.src = currentExampleImageUrl;
                        exampleImageOverlayElement.style.display = 'block';
                    }
                    tempImg.src = currentExampleImageUrl;
                    showToast('"example.jpg" found and displayed.', 'info');
                } else {
                    exampleImageOverlayElement.style.display = 'none';
                    exampleImageOverlayElement.style.width = ''; 
                    exampleImageOverlayElement.style.height = '';
                    showToast('"example.jpg" not found in folder.', 'info');
                }
                
                Promise.all(promises).then(() => {
                    reclusterAndDisplay(); 
                    if (imageFileCount > 0) {
                        imageCountTextElement.innerHTML = `Processed <strong class="text-green-700">${imageFileCount}</strong> files. 
                                                       <strong class="text-pink-600">${photosWithGPSCount}</strong> photo(s) with GPS added.`;
                        showToast(`EXIF complete. ${photosWithGPSCount} photos with GPS added.`, 'success', 5000);
                    } else if (!exampleImageFile) {
                        imageCountTextElement.textContent = 'No processable image files (JPG, TIFF for EXIF) or example.jpg found.';
                         showToast('No relevant files found.', 'info');
                    }
                    folderInputElement.value = '';
                });
            });
            
            map.on('zoomend', function() {
                reclusterAndDisplay();
            });
            map.on('moveend', function() {
                reclusterAndDisplay();
            });

            const togglePanelButton = document.getElementById('togglePanelButton');
            const leftPanelContainer = document.getElementById('leftPanelContainer'); 
            const panelContentWrapper = document.getElementById('panelContentWrapper'); 
            const mapContainerOuter = document.getElementById('mapContainerOuter'); 
            let isPanelContentVisible = true; 

            togglePanelButton.className = 'toggle-button-panel-visible';

            togglePanelButton.addEventListener('click', () => {
                isPanelContentVisible = !isPanelContentVisible;
                if (isPanelContentVisible) { 
                    panelContentWrapper.classList.remove('hidden');
                    leftPanelContainer.classList.remove('lg:w-auto', 'w-auto', 'p-0', 'items-start');
                    leftPanelContainer.classList.add('lg:w-1/3'); 
                    
                    togglePanelButton.textContent = 'Hide Details Panel';
                    togglePanelButton.className = 'toggle-button-panel-visible';
                    leftPanelContainer.insertBefore(togglePanelButton, panelContentWrapper);

                    mapContainerOuter.classList.remove('lg:w-full');
                    mapContainerOuter.classList.add('lg:w-2/3');
                } else { 
                    panelContentWrapper.classList.add('hidden');
                    leftPanelContainer.classList.remove('lg:w-1/3'); 
                    leftPanelContainer.classList.add('lg:w-auto', 'w-auto', 'p-0', 'items-start'); 
                    
                    togglePanelButton.textContent = '-';
                    togglePanelButton.className = 'toggle-button-panel-hidden';
                    mapContainerOuter.appendChild(togglePanelButton); 

                    mapContainerOuter.classList.add('lg:w-full');
                    mapContainerOuter.classList.remove('lg:w-2/3');
                }
                setTimeout(() => {
                    map.invalidateSize();
                }, 310); 
            });

            const mapElement = document.getElementById('map'); 
            const resizeObserver = new ResizeObserver(() => {
                map.invalidateSize();
            });
            resizeObserver.observe(mapContainerOuter); 
        }); 
    </script>
</body>
</html>
