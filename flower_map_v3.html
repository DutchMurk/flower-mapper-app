<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flower Location Mapper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js" defer></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; 
        }
        #map {
            height: 100%;
            min-height: 400px;
            border-radius: 0.5rem;
        }
        .leaflet-popup-content-wrapper { 
            border-radius: 0.375rem;
        }
        .custom-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        .custom-toast.show {
            opacity: 1;
        }
        .custom-toast.success {
            background-color: #28a745;
        }
        .custom-toast.error {
            background-color: #dc3545;
        }
        .custom-toast.info {
            background-color: #17a2b8;
        }
        input[type="file"]::file-selector-button {
            margin-right: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            background-color: #FFF;
            color: #374151;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #F9FAFB;
        }
        #folderProcessingLogs {
            max-height: 100px; 
            overflow-y: auto;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            line-height: 1.4;
        }
        #folderProcessingLogs p {
            margin-bottom: 0.25rem;
        }
        .title-input {
            background-color: transparent;
            border: none;
            outline: none;
            box-shadow: none;
            text-align: center;
            width: 100%;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        .title-input:focus {
            ring-width: 0;
            box-shadow: none;
        }
        .scientific-name-input {
            font-size: 1.875rem; 
            line-height: 2.25rem;
            font-weight: 700; 
            color: #db2777; 
        }
        @media (min-width: 768px) { 
            .scientific-name-input {
                font-size: 2.25rem; 
                line-height: 2.5rem;
            }
        }
        .dutch-name-input {
            color: #4b5563; 
            margin-top: 0.25rem; 
            font-size: 1rem; 
            line-height: 1.5rem;
        }
        #mapContainerOuter { 
            position: relative;
            transition: margin-left 0.3s ease-in-out; 
            margin-left: 24px; 
        }
        #exampleImageOverlay {
            position: absolute;
            bottom: 10px; 
            left: 10px;   
            max-width: 25%;  
            max-height: 35%; 
            border: 2px solid white;
            border-radius: 0.375rem; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            z-index: 900; 
            display: none; 
        }
        
        /* Slide-out Panel Styles */
        #leftPanelContainer {
            position: fixed;
            top: 0;
            left: 0; 
            height: 100vh;
            width: 350px; 
            background-color: white;
            z-index: 1002; 
            transform: translateX(calc(-100% + 24px)); 
            transition: transform 0.3s ease-in-out; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.15);
            display: flex; 
            flex-direction: column;
            /* border: 2px solid red; REMOVED DEBUG BORDER */
        }
        #panelContentWrapper{
             padding: 1.5rem; 
             height: 100%; 
             overflow-y: auto;
             flex-grow: 1;
             margin-right: 24px; 
        }

        #slidePanelToggle { 
            position: absolute; 
            top: 50%;
            right: 0px; 
            transform: translateY(-50%);
            width: 24px; 
            height: 48px; 
            background-color: #6B7280; 
            color: white;
            border: none; /* REMOVED DEBUG BORDER FOR HANDLE */
            border-top-right-radius: 6px; 
            border-bottom-right-radius: 6px;
            cursor: pointer;
            font-size: 1.25rem; 
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 0px 5px rgba(0,0,0,0.2);
            z-index: 10; 
        }
         #slidePanelToggle:hover {
            background-color: #4B5563; 
        }


        .custom-cluster-icon {
            background-color: rgba(0, 120, 255, 0.6); 
            border: 2px solid rgba(0, 100, 220, 1);   
            border-radius: 50%;
            color: white;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 0 5px rgba(0,0,0,0.4);
        }

        #galleryModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.75); z-index: 10001; 
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out;
        }
        #galleryModal.show { opacity: 1; pointer-events: auto; }
        .gallery-content {
            position: relative; background-color: white; padding: 20px; border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center;
            max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column;
        }
        .gallery-image-container {
            flex-grow: 1; display: flex; align-items: center; justify-content: center;
            overflow: hidden; margin-bottom: 5px; 
        }
        #galleryImage { max-width: 100%; max-height: 60vh; object-fit: contain; border-radius: 0.25rem; }
        .gallery-info {
            margin-bottom: 10px;
        }
        #galleryFilename { font-size: 0.9rem; color: #4A5568; margin-bottom: 2px; }
        #galleryCoordinates { font-size: 0.75rem; color: #718096; } 
        #galleryDate { font-size: 0.75rem; color: #718096; margin-top: 1px; } 
        .gallery-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .gallery-nav-button {
            background-color: #4A5568; color: white; border: none; padding: 8px 16px;
            border-radius: 0.375rem; cursor: pointer; font-size: 1.5rem;
        }
        .gallery-nav-button:hover { background-color: #2D3748; }
        .gallery-nav-button:disabled { background-color: #A0AEC0; cursor: not-allowed; }
        #galleryCloseButton {
            position: absolute; top: 8px; right: 8px; background: rgba(230, 230, 230, 0.8);
            border: 1px solid #b0b0b0; border-radius: 50%; width: 32px; height: 32px;
            font-size: 1.6rem; color: #333; cursor: pointer; z-index: 10;
            display: flex; align-items: center; justify-content: center; line-height: 1; padding: 0;
        }
         #galleryCloseButton:hover { background-color: rgba(200, 200, 200, 1); color: #000; }
        
        #speciesListContainer {
            max-height: calc(100vh - 250px); 
            overflow-y: auto;
            border: 1px solid #e5e7eb; 
            border-radius: 0.375rem; 
            padding: 0.5rem;
            background-color: #f9fafb; 
        }
        .genus-header {
            padding: 0.6rem 0.5rem;
            cursor: pointer;
            font-weight: 600;
            background-color: #e9d5ff; 
            border-bottom: 1px solid #d8b4fe; 
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .genus-name-text { 
            flex-grow: 1; 
        }
        .genus-header:hover {
            background-color: #c084fc; 
            color: white;
        }
        .genus-header .arrow {
            transition: transform 0.2s ease-in-out;
            padding: 0 0.5rem; 
        }
        .genus-header.expanded .arrow {
            transform: rotate(90deg);
        }
        .species-sublist {
            padding-left: 1rem; 
            display: none; 
            background-color: white;
            border-top: 1px solid #e5e7eb;
        }
        .species-sublist.expanded {
            display: block;
        }
        .species-list-item {
            padding: 0.5rem;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6; 
        }
        .species-list-item:last-child {
            border-bottom: none;
        }
        .species-list-item:hover {
            background-color: #eff6ff; 
        }
        .species-list-item.selected {
            background-color: #bfdbfe; 
            font-weight: 600;
        }
        #zoomLevelDisplay {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 2px 8px;
            font-size: 0.8rem;
            border-radius: 0.25rem;
            z-index: 900; 
            color: #333;
        }
        .panel-section { 
            margin-bottom: 1.5rem; 
        }
        .panel-section:last-child {
            margin-bottom: 0;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    
    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-4 text-center">
            <div>
                <input type="text" id="scientificNameInput" class="title-input scientific-name-input" placeholder="Scientific Flower Name">
            </div>
            <div>
                <input type="text" id="dutchNameInput" class="title-input dutch-name-input" placeholder="Dutch Flower Name">
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-6 mt-4 relative"> 
            <div id="leftPanelContainer" class=""> 
                <button id="slidePanelToggle">☰</button> 
                <div id="panelContentWrapper" class="grow overflow-auto">
                    <div id="parentFolderSelectionSection" class="bg-white p-6 rounded-lg shadow-lg panel-section">
                        <h2 class="text-xl font-semibold mb-4 text-purple-600">Select Parent Folder</h2>
                        <p class="text-sm text-gray-600 mb-3">
                            Choose the main folder containing subfolders for each species (e.g., "Orchideeenfoto's").
                        </p>
                        <div>
                            <label for="parentFolderInput" class="block text-sm font-medium text-gray-700">Select Parent Folder:</label>
                            <input type="file" id="parentFolderInput" webkitdirectory directory
                                   class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 cursor-pointer"/>
                        </div>
                    </div>
                    
                    <div id="speciesSelectionSection" class="bg-white p-6 rounded-lg shadow-lg panel-section" style="display: none;">
                        <h2 class="text-xl font-semibold mb-2 text-green-600">Select Species by Genus</h2>
                        <input type="text" id="speciesSearchInput" placeholder="Search species/genus..."
                               class="w-full px-3 py-2 mb-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <p class="text-sm text-gray-600 mb-3">
                            Click genus name to view on map, or arrow to expand/collapse. Then select a specific species if desired.
                        </p>
                        <div id="speciesListContainer">
                        </div>
                    </div>

                    <div id="logDisplayArea" class="bg-white p-6 rounded-lg shadow-lg panel-section" style="display: none;">
                        <div id="folderProcessResult" class="mt-1 text-sm space-y-2">
                            <p id="imageCountText" style="display:none;"></p>
                            <div id="folderProcessingLogsContainer" style="display: none;">
                                 <h4 class="font-semibold text-gray-700 mb-2">Processing Log:</h4>
                                 <div id="folderProcessingLogs"></div>
                            </div>
                        </div>
                         <p class="mt-4 text-xs text-gray-500">
                            Supports JPG, TIFF images with GPS EXIF data.
                        </p>
                    </div>
                </div>
            </div>

            <div id="mapContainerOuter" class="lg:w-full h-[500px] md:h-[600px] lg:h-[calc(100vh-12rem)] shadow-lg rounded-lg overflow-hidden"> 
                <div id="map"></div>
                <img id="exampleImageOverlay" src="#" alt="Example flower image" />
                <div id="zoomLevelDisplay">Zoom: N/A</div> 
            </div>
        </div>

        <footer class="mt-8 text-center text-sm text-gray-500">
            <p>&copy; <span id="currentYear"></span> Flower Mapper. Happy exploring!</p>
        </footer>
    </div>

    <div id="galleryModal">
        <div class="gallery-content">
            <button id="galleryCloseButton">&times;</button>
            <div class="gallery-image-container">
                <img id="galleryImage" src="#" alt="Gallery image" />
            </div>
            <div class="gallery-info">
                <p id="galleryFilename">Filename.jpg</p>
                <p id="galleryCoordinates">Lat: N/A, Lon: N/A</p>
                <p id="galleryDate">(Datum niet beschikbaar)</p> 
            </div>
            <div class="gallery-controls">
                <button id="galleryPrevButton" class="gallery-nav-button">&larr;</button>
                <span id="galleryCounter">1 / 1</span>
                <button id="galleryNextButton" class="gallery-nav-button">&rarr;</button>
            </div>
        </div>
    </div>

    <div id="customToast" class="custom-toast">
        <span id="toastMessage"></span>
    </div>

    <script>
        window.addEventListener('load', function() { 
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            const map = L.map('map').setView([51.1657, 10.4515], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            let allOriginalPhotoLocations = []; 
            let activeClusterMarkers = []; 
            let groupedSpeciesData = []; 

            const scientificNameInputElement = document.getElementById('scientificNameInput');
            const dutchNameInputElement = document.getElementById('dutchNameInput');
            const exampleImageOverlayElement = document.getElementById('exampleImageOverlay');
            const mapContainerOuterElement = document.getElementById('mapContainerOuter'); 
            const toastElement = document.getElementById('customToast');
            const toastMessageElement = document.getElementById('toastMessage');
            let toastTimeout;
            let currentExampleImageUrl = null; 

            const galleryModal = document.getElementById('galleryModal');
            const galleryImageElement = document.getElementById('galleryImage');
            const galleryFilenameElement = document.getElementById('galleryFilename');
            const galleryCoordinatesElement = document.getElementById('galleryCoordinates'); 
            const galleryDateElement = document.getElementById('galleryDate'); 
            const galleryPrevButton = document.getElementById('galleryPrevButton');
            const galleryNextButton = document.getElementById('galleryNextButton');
            const galleryCloseButton = document.getElementById('galleryCloseButton');
            const galleryCounterElement = document.getElementById('galleryCounter');
            let currentGalleryPhotosData = []; 
            let currentGalleryIndex = 0;
            let currentGalleryObjectUrls = []; 

            const parentFolderInputElement = document.getElementById('parentFolderInput'); 
            const parentFolderSelectionSection = document.getElementById('parentFolderSelectionSection'); 
            const speciesSelectionSection = document.getElementById('speciesSelectionSection');
            const speciesListContainer = document.getElementById('speciesListContainer');
            const speciesSearchInputElement = document.getElementById('speciesSearchInput'); 
            const logDisplayArea = document.getElementById('logDisplayArea'); 
            const imageCountTextElement = document.getElementById('imageCountText');
            const folderProcessingLogsContainer = document.getElementById('folderProcessingLogsContainer');
            const folderProcessingLogsElement = document.getElementById('folderProcessingLogs');
            
            const slidePanelToggleButton = document.getElementById('slidePanelToggle'); 
            const leftPanelContainer = document.getElementById('leftPanelContainer'); 
            const panelContentWrapper = document.getElementById('panelContentWrapper');
            let isPanelOpen = false; 
            
            const zoomLevelDisplayElement = document.getElementById('zoomLevelDisplay'); 
            const PANEL_WIDTH = 350; 
            const HANDLE_WIDTH = 24; 

            // Initial UI State - Panel starts closed with handle peeking
            leftPanelContainer.style.transform = `translateX(calc(-${PANEL_WIDTH}px + ${HANDLE_WIDTH}px))`; 
            mapContainerOuterElement.style.marginLeft = `${HANDLE_WIDTH}px`; 
            slidePanelToggleButton.innerHTML = '☰'; 
            isPanelOpen = false; 

            parentFolderSelectionSection.style.display = 'block';
            speciesSelectionSection.style.display = 'none';
            logDisplayArea.style.display = 'none';


            function showToast(message, type = 'success', duration = 3000) {
                toastMessageElement.textContent = message;
                toastElement.className = 'custom-toast show ' + type;
                clearTimeout(toastTimeout);
                toastTimeout = setTimeout(() => {
                    toastElement.classList.remove('show');
                }, duration);
            }
            
            function resetUIForNewParentFolder() { 
                speciesListContainer.innerHTML = '<p id="noSpeciesFound" class="text-gray-500">Select a parent folder to see species.</p>'; 
                
                parentFolderSelectionSection.style.display = 'block'; 
                speciesSelectionSection.style.display = 'none';
                logDisplayArea.style.display = 'none';

                scientificNameInputElement.value = '';
                dutchNameInputElement.value = '';
                speciesSearchInputElement.value = ''; 

                if (currentExampleImageUrl) {
                    URL.revokeObjectURL(currentExampleImageUrl);
                    currentExampleImageUrl = null;
                }
                exampleImageOverlayElement.style.display = 'none';
                exampleImageOverlayElement.src = "#";
                exampleImageOverlayElement.style.width = ''; 
                exampleImageOverlayElement.style.height = '';
                
                allOriginalPhotoLocations = [];
                groupedSpeciesData = [];
                reclusterAndDisplay(); 
                closeGalleryModal(); 
            }
            
            function resetUIForNewSpeciesSelection() {
                folderProcessingLogsContainer.style.display = 'none'; 
                folderProcessingLogsElement.innerHTML = '';
                
                parentFolderSelectionSection.style.display = 'none'; 
                speciesSelectionSection.style.display = 'block'; 
                logDisplayArea.style.display = 'none'; 


                if (currentExampleImageUrl) {
                    URL.revokeObjectURL(currentExampleImageUrl);
                    currentExampleImageUrl = null;
                }
                exampleImageOverlayElement.style.display = 'none'; 
                exampleImageOverlayElement.src = "#";
                exampleImageOverlayElement.style.width = ''; 
                exampleImageOverlayElement.style.height = '';
                
                allOriginalPhotoLocations = [];
                reclusterAndDisplay(); 
                closeGalleryModal(); 
            }


            function createClusterIcon(count) {
                const size = count < 10 ? 30 : (count < 100 ? 35 : 40);
                return L.divIcon({
                    html: `<div style="line-height: ${size}px;">${count}</div>`,
                    className: 'custom-cluster-icon',
                    iconSize: [size, size]
                });
            }

            function getDynamicClusterThreshold() {
                const zoom = map.getZoom();
                if (zoom <= 6) return 50000;  
                if (zoom <= 8) return 10000;  
                if (zoom <= 10) return 2000;   
                if (zoom <= 12) return 500;    
                if (zoom <= 14) return 100;    
                return 50; 
            }
            
            function parseExifDate(dateString) {
                if (!dateString) return null;
                const parts = dateString.split(" ")[0].split(":");
                if (parts.length === 3) {
                    return new Date(parts[0], parts[1] - 1, parts[2]);
                }
                return null;
            }

            function openGalleryModal(photosData, startIndex = 0) { 
                if (!photosData || photosData.length === 0) return;
                
                currentGalleryObjectUrls.forEach(url => URL.revokeObjectURL(url));
                currentGalleryObjectUrls = [];

                const sortedPhotosData = [...photosData].sort((a, b) => {
                    const dateA = parseExifDate(a.date);
                    const dateB = parseExifDate(b.date);
                    if (dateA && dateB) {
                        return dateB - dateA; 
                    }
                    if (dateA) return -1; 
                    if (dateB) return 1;  
                    return 0; 
                });

                currentGalleryPhotosData = sortedPhotosData; 
                currentGalleryIndex = startIndex;
                displayGalleryImage();
                galleryModal.classList.add('show');
            }

            function closeGalleryModal() {
                galleryModal.classList.remove('show');
                currentGalleryObjectUrls.forEach(url => URL.revokeObjectURL(url));
                currentGalleryObjectUrls = [];
                galleryImageElement.src = "#"; 
            }
            
            function formatExifDateToDutch(dateString) {
                if (!dateString) return "(Datum niet beschikbaar)";
                const dateObj = parseExifDate(dateString);
                if (!dateObj) return "(Ongeldig datumformaat)";
                
                const day = dateObj.getDate(); 
                const month = dateObj.getMonth(); 
                const year = dateObj.getFullYear();

                const dutchMonths = ["jan", "feb", "mrt", "apr", "mei", "jun", "jul", "aug", "sep", "okt", "nov", "dec"];
                
                return `(${day} ${dutchMonths[month]} ${year})`; 
            }


            function displayGalleryImage() {
                if (currentGalleryPhotosData.length === 0 || currentGalleryIndex < 0 || currentGalleryIndex >= currentGalleryPhotosData.length) return;
                
                const currentPhotoData = currentGalleryPhotosData[currentGalleryIndex];
                const file = currentPhotoData.fileObject;
                const objectURL = URL.createObjectURL(file);
                currentGalleryObjectUrls.push(objectURL); 

                galleryImageElement.src = objectURL;
                galleryFilenameElement.textContent = currentPhotoData.desc; 
                galleryCoordinatesElement.textContent = `Lat: ${currentPhotoData.lat.toFixed(4)}, Lon: ${currentPhotoData.lon.toFixed(4)}`;
                galleryDateElement.textContent = formatExifDateToDutch(currentPhotoData.date); 
                galleryCounterElement.textContent = `${currentGalleryIndex + 1} / ${currentGalleryPhotosData.length}`;

                galleryPrevButton.disabled = currentGalleryIndex === 0;
                galleryNextButton.disabled = currentGalleryIndex === currentGalleryPhotosData.length - 1;
            }

            galleryPrevButton.addEventListener('click', () => {
                if (currentGalleryIndex > 0) { currentGalleryIndex--; displayGalleryImage(); }
            });
            galleryNextButton.addEventListener('click', () => {
                if (currentGalleryIndex < currentGalleryPhotosData.length - 1) { currentGalleryIndex++; displayGalleryImage(); }
            });
            galleryCloseButton.addEventListener('click', closeGalleryModal);
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && galleryModal.classList.contains('show')) closeGalleryModal();
            });

            function reclusterAndDisplay() {
                activeClusterMarkers.forEach(marker => map.removeLayer(marker));
                activeClusterMarkers = [];

                if (allOriginalPhotoLocations.length === 0) {
                    return;
                }

                const currentThreshold = getDynamicClusterThreshold();
                let tempClusters = []; 

                allOriginalPhotoLocations.forEach(pointData => {
                    const pointLatLng = L.latLng(pointData.lat, pointData.lon);
                    let foundCluster = null;
                    for (let i = 0; i < tempClusters.length; i++) {
                        const cluster = tempClusters[i];
                        const clusterLatLng = L.latLng(cluster.lat, cluster.lon);
                        if (pointLatLng.distanceTo(clusterLatLng) < currentThreshold) {
                            foundCluster = cluster;
                            break;
                        }
                    }
                    if (foundCluster) {
                        foundCluster.points.push(pointData); 
                    } else {
                        tempClusters.push({ lat: pointData.lat, lon: pointData.lon, points: [pointData] });
                    }
                });

                tempClusters.forEach(cluster => {
                    let marker;
                    marker = L.marker([cluster.lat, cluster.lon], { icon: createClusterIcon(cluster.points.length) });
                    
                    marker.on('click', function() {
                        openGalleryModal(cluster.points, 0);
                    });

                    marker.addTo(map);
                    activeClusterMarkers.push(marker);
                    cluster.marker = marker; 
                });
                 window.currentClustersForDebug = tempClusters; 
            }
            
            function convertDMSToDD(degrees, minutes, seconds, direction) {
                let dd = degrees + minutes / 60 + seconds / (60 * 60);
                if (direction === "S" || direction === "W") {
                    dd = dd * -1;
                }
                return dd;
            }

            function extractNamesAndGenusFromFolderName(folderName) { 
                let scientificName = folderName;
                let dutchName = '';
                let genusName = scientificName.split(' ')[0]; 

                const dutchNameMatch = folderName.match(/\(([^)]+)\)/);
                if (dutchNameMatch && dutchNameMatch[1]) {
                    dutchName = dutchNameMatch[1].trim();
                    scientificName = folderName.substring(0, dutchNameMatch.index).trim();
                    genusName = scientificName.split(' ')[0]; 
                }
                return { scientificName, dutchName, genusName };
            }

            function toggleSlidePanel() {
                isPanelOpen = !isPanelOpen;
                if (isPanelOpen) {
                    leftPanelContainer.style.transform = 'translateX(0)';
                    mapContainerOuterElement.style.marginLeft = `${PANEL_WIDTH}px`;
                    slidePanelToggleButton.innerHTML = '&times;'; 
                    
                    if (groupedSpeciesData.length === 0) { 
                        parentFolderSelectionSection.style.display = 'block';
                        speciesSelectionSection.style.display = 'none';
                        logDisplayArea.style.display = 'none';
                    } else { 
                        parentFolderSelectionSection.style.display = 'none';
                        speciesSelectionSection.style.display = 'block';
                        logDisplayArea.style.display = 'none'; 
                        groupedSpeciesData.forEach(genus => genus.isExpanded = false);
                        renderSpeciesAccordion(speciesSearchInputElement.value); 
                    }
                } else { 
                    leftPanelContainer.style.transform = `translateX(calc(-${PANEL_WIDTH}px + ${HANDLE_WIDTH}px))`;
                    mapContainerOuterElement.style.marginLeft = `${HANDLE_WIDTH}px`;
                    slidePanelToggleButton.innerHTML = '☰'; 
                }
                setTimeout(() => {
                    map.invalidateSize();
                }, 300); 
            }
            
            slidePanelToggleButton.addEventListener('click', toggleSlidePanel);


            async function processFileList(filesToProcess, viewTitle, isGenusView = false) {
                resetUIForNewSpeciesSelection(); 
                
                if (!isGenusView && allOriginalPhotoLocations.length === 0) { 
                    map.setView([47.5, 10.8], 5);
                }
                updateZoomLevel(); 

                // Show log area only if there are files to process (EXIF readable ones)
                let exifProcessableFileCount = filesToProcess.filter(file => 
                    ['image/jpeg', 'image/tiff'].includes(file.type) || 
                    ['.jpg', '.jpeg', '.tif', '.tiff'].includes(file.name.substring(file.name.lastIndexOf('.')).toLowerCase())
                ).length;

                if (exifProcessableFileCount > 0) {
                    logDisplayArea.style.display = 'block'; 
                    folderProcessingLogsContainer.style.display = 'block';
                    folderProcessingLogsElement.innerHTML = '';
                } else {
                     logDisplayArea.style.display = 'none';
                }


                let exampleImageFile = null;
                let photosWithGPSCount = 0;
                const promises = [];

                for (const file of filesToProcess) {
                     if (file.name.toLowerCase() === 'example.jpg') {
                        exampleImageFile = file;
                    }
                    if (['image/jpeg', 'image/tiff'].includes(file.type) || ['.jpg', '.jpeg', '.tif', '.tiff'].includes(file.name.substring(file.name.lastIndexOf('.')).toLowerCase())) {
                        if (folderProcessingLogsElement) { // Check if log element exists
                            const logEntry = document.createElement('p');
                            logEntry.textContent = `Processing for EXIF: ${file.name}...`;
                            folderProcessingLogsElement.appendChild(logEntry);
                            folderProcessingLogsElement.scrollTop = folderProcessingLogsElement.scrollHeight;
                        }

                        promises.push(new Promise(async (resolveFile) => {
                            try {
                                const exifData = await new Promise((resolve, reject) => {
                                    EXIF.getData(file, function() { 
                                        const allTags = EXIF.getAllTags(this);
                                        if (Object.keys(allTags).length > 0) resolve(allTags);
                                        else reject(new Error("No EXIF data found."));
                                    });
                                    setTimeout(() => reject(new Error("EXIF.getData timed out")), 7000); 
                                });
                                const latData = exifData.GPSLatitude;
                                const lonData = exifData.GPSLongitude;
                                const latRef = exifData.GPSLatitudeRef;
                                const lonRef = exifData.GPSLongitudeRef;
                                const dateTaken = exifData.DateTimeOriginal || exifData.DateTime; 

                                if (latData && lonData && latRef && lonRef) {
                                    const latitude = convertDMSToDD(latData[0], latData[1], latData[2], latRef);
                                    const longitude = convertDMSToDD(lonData[0], lonData[1], lonData[2], lonRef);
                                    const photoData = { lat: latitude, lon: longitude, desc: file.name, fileObject: file, date: dateTaken }; 
                                    allOriginalPhotoLocations.push(photoData);
                                    photosWithGPSCount++;
                                    if (folderProcessingLogsElement && folderProcessingLogsElement.lastChild && folderProcessingLogsElement.lastChild.textContent.startsWith(`Processing for EXIF: ${file.name}`)) {
                                       folderProcessingLogsElement.lastChild.innerHTML += ` <span class="text-green-600">GPS found - Stored.</span>`;
                                    }
                                } else {
                                     if (folderProcessingLogsElement && folderProcessingLogsElement.lastChild && folderProcessingLogsElement.lastChild.textContent.startsWith(`Processing for EXIF: ${file.name}`)) {
                                       folderProcessingLogsElement.lastChild.innerHTML += ` <span class="text-gray-500">No GPS data.</span>`;
                                    }
                                }
                            } catch (error) {
                                console.error("Error EXIF " + file.name + ":", error);
                                if (folderProcessingLogsElement && folderProcessingLogsElement.lastChild && folderProcessingLogsElement.lastChild.textContent.startsWith(`Processing for EXIF: ${file.name}`)) {
                                    folderProcessingLogsElement.lastChild.innerHTML += ` <span class="text-red-600">Error (${error.message}).</span>`;
                                }
                            }
                            resolveFile();
                        }));
                    }
                }

                if (exampleImageFile && !isGenusView) { 
                    currentExampleImageUrl = URL.createObjectURL(exampleImageFile);
                    const tempImg = new Image();
                    tempImg.onload = function() {
                        const maxAllowedWidth = mapContainerOuterElement.clientWidth * 0.20; 
                        const maxAllowedHeight = mapContainerOuterElement.clientHeight * 0.30; 
                        let newWidth = tempImg.naturalWidth;
                        let newHeight = tempImg.naturalHeight;
                        if (newWidth > maxAllowedWidth) {
                            newHeight = (maxAllowedWidth / newWidth) * newHeight;
                            newWidth = maxAllowedWidth;
                        }
                        if (newHeight > maxAllowedHeight) {
                            newWidth = (maxAllowedHeight / newHeight) * newWidth;
                            newHeight = maxAllowedHeight;
                        }
                        exampleImageOverlayElement.style.width = newWidth + 'px';
                        exampleImageOverlayElement.style.height = newHeight + 'px';
                        exampleImageOverlayElement.src = currentExampleImageUrl;
                        exampleImageOverlayElement.style.display = 'block';
                    }
                    tempImg.src = currentExampleImageUrl;
                    showToast('"example.jpg" found and displayed.', 'info');
                } else {
                    exampleImageOverlayElement.style.display = 'none';
                    exampleImageOverlayElement.style.width = ''; 
                    exampleImageOverlayElement.style.height = '';
                    if (!isGenusView && exampleImageFile) showToast('"example.jpg" not shown for genus view.', 'info');
                    else if (!isGenusView) showToast('"example.jpg" not found in this species folder.', 'info');
                }
                
                await Promise.all(promises); 
                reclusterAndDisplay(); 

                if (allOriginalPhotoLocations.length > 0) {
                    const bounds = L.latLngBounds(allOriginalPhotoLocations.map(p => [p.lat, p.lon]));
                    if (bounds.isValid()) {
                        map.fitBounds(bounds, { padding: [50, 50] }); 
                    }
                } else if (!isGenusView) { 
                    map.setView([47.5, 10.8], 5); 
                }
                updateZoomLevel();

                if (logDisplayArea.style.display === 'block') { // If logs were shown
                    imageCountTextElement.innerHTML = `Processed <strong class="text-green-700">${filesToProcess.length}</strong> files for ${viewTitle}. 
                                                   <strong class="text-pink-600">${photosWithGPSCount}</strong> photo(s) with GPS added.`;
                }
                showToast(`Displaying ${photosWithGPSCount} photo(s) for ${viewTitle}.`, 'success', 4000);
                
                // Hide log area after a short delay after showing the summary toast
                setTimeout(() => {
                    logDisplayArea.style.display = 'none';
                }, 5000);
                
                if (isPanelOpen) { 
                    toggleSlidePanel(); 
                }
            }

            async function processSelectedSpecies(speciesData) {
                scientificNameInputElement.value = speciesData.scientificName;
                dutchNameInputElement.value = speciesData.dutchName || "N/A";
                await processFileList(speciesData.filesInSubfolder, speciesData.scientificName, false);
            }

            async function processSelectedGenus(genusGroupData) {
                scientificNameInputElement.value = `${genusGroupData.genusName} family`;
                dutchNameInputElement.value = "(Genus Overview)";
                
                let allFilesInGenus = [];
                genusGroupData.speciesList.forEach(species => {
                    allFilesInGenus = allFilesInGenus.concat(species.filesInSubfolder);
                });
                await processFileList(allFilesInGenus, `${genusGroupData.genusName} family`, true);
            }


            function renderSpeciesAccordion(filterText = "") {
                speciesListContainer.innerHTML = ''; 
                const searchTerm = filterText.toLowerCase();
                let matchFound = false;

                groupedSpeciesData.forEach(genusGroup => {
                    const genusNameMatches = genusGroup.genusName.toLowerCase().includes(searchTerm);
                    const matchingSpecies = genusGroup.speciesList.filter(species => 
                        species.scientificName.toLowerCase().includes(searchTerm) ||
                        (species.dutchName && species.dutchName.toLowerCase().includes(searchTerm))
                    );

                    if (!genusNameMatches && matchingSpecies.length === 0 && searchTerm) {
                        return; 
                    }
                    matchFound = true;

                    const genusDiv = document.createElement('div');
                    const genusHeader = document.createElement('div');
                    genusHeader.className = 'genus-header';
                    
                    const genusNameSpan = document.createElement('span');
                    genusNameSpan.className = 'genus-name-text';
                    genusNameSpan.textContent = `${genusGroup.genusName} (${genusGroup.speciesList.length})`;
                    
                    const arrowSpan = document.createElement('span');
                    arrowSpan.className = 'arrow';
                    arrowSpan.innerHTML = '&#9654;'; 

                    genusHeader.appendChild(genusNameSpan);
                    genusHeader.appendChild(arrowSpan);
                    
                    const speciesSubList = document.createElement('div');
                    speciesSubList.className = 'species-sublist';

                    if (genusGroup.isExpanded || (searchTerm && (genusNameMatches || matchingSpecies.length > 0))) {
                        speciesSubList.classList.add('expanded');
                        genusHeader.classList.add('expanded');
                    }


                    const speciesToDisplay = searchTerm && !genusNameMatches ? matchingSpecies : genusGroup.speciesList;

                    speciesToDisplay.forEach(species => {
                        const speciesItem = document.createElement('div');
                        speciesItem.className = 'species-list-item';
                        speciesItem.textContent = `${species.scientificName}${species.dutchName ? ` (${species.dutchName})` : ''}`;
                        speciesItem.onclick = (event) => {
                            event.stopPropagation(); 
                            speciesListContainer.querySelectorAll('.species-list-item.selected').forEach(el => el.classList.remove('selected'));
                            speciesListContainer.querySelectorAll('.genus-header.selected').forEach(el => el.classList.remove('selected')); 
                            speciesItem.classList.add('selected'); 
                            processSelectedSpecies(species);
                        };
                        speciesSubList.appendChild(speciesItem);
                    });
                    
                    if (speciesToDisplay.length > 0 || !searchTerm) { 
                        arrowSpan.onclick = (event) => {
                            event.stopPropagation(); 
                            genusGroup.isExpanded = !genusGroup.isExpanded; 
                            speciesSubList.classList.toggle('expanded');
                            genusHeader.classList.toggle('expanded');
                        };

                        genusNameSpan.onclick = () => { 
                            speciesListContainer.querySelectorAll('.species-list-item.selected').forEach(el => el.classList.remove('selected'));
                            speciesListContainer.querySelectorAll('.genus-header.selected').forEach(el => el.classList.remove('selected'));
                            genusHeader.classList.add('selected');
                            processSelectedGenus(genusGroup);
                        };
                        genusDiv.appendChild(genusHeader);
                        genusDiv.appendChild(speciesSubList);
                        speciesListContainer.appendChild(genusDiv);
                    } else if (searchTerm && matchingSpecies.length === 0 && !genusNameMatches) {
                        genusDiv.style.display = 'none';
                    }
                });
                
                if (!matchFound && searchTerm) {
                     const noResultsP = document.createElement('p');
                    noResultsP.className = 'text-gray-500 p-2';
                    noResultsP.textContent = 'No matching species or genus found.';
                    speciesListContainer.appendChild(noResultsP);
                } else if (groupedSpeciesData.length === 0 || (!matchFound && !searchTerm)) {
                     const noSpeciesP = document.createElement('p');
                    noSpeciesP.id = 'noSpeciesFound'; 
                    noSpeciesP.className = 'text-gray-500';
                    noSpeciesP.textContent = 'No species subfolders found or parsed correctly.';
                    speciesListContainer.appendChild(noSpeciesP);
                }
            }

            speciesSearchInputElement.addEventListener('input', function(event) {
                renderSpeciesAccordion(event.target.value);
            });


            parentFolderInputElement.addEventListener('change', async function(event) { 
                const files = event.target.files;
                if (!files || files.length === 0) {
                    showToast('No parent folder selected or folder is empty.', 'info');
                    return;
                }
                
                resetUIForNewParentFolder(); 
                
                const tempGenusMap = new Map(); 

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const relativePath = file.webkitRelativePath; 
                    const pathParts = relativePath.split('/');

                    if (pathParts.length > 2) { 
                        const speciesSubfolderName = pathParts[1];
                        const { scientificName, dutchName, genusName } = extractNamesAndGenusFromFolderName(speciesSubfolderName);

                        if (!tempGenusMap.has(genusName)) {
                            tempGenusMap.set(genusName, {
                                genusName: genusName,
                                isExpanded: false, 
                                speciesList: []
                            });
                        }
                        
                        let speciesEntry = tempGenusMap.get(genusName).speciesList.find(s => s.originalSubfolderName === speciesSubfolderName);
                        if (!speciesEntry) {
                            speciesEntry = {
                                scientificName,
                                dutchName,
                                originalSubfolderName: speciesSubfolderName,
                                filesInSubfolder: []
                            };
                            tempGenusMap.get(genusName).speciesList.push(speciesEntry);
                        }
                        speciesEntry.filesInSubfolder.push(file);
                    }
                }

                groupedSpeciesData = Array.from(tempGenusMap.values());
                groupedSpeciesData.sort((a, b) => a.genusName.localeCompare(b.genusName));
                groupedSpeciesData.forEach(genus => {
                    genus.speciesList.sort((a,b) => a.scientificName.localeCompare(b.scientificName));
                });

                renderSpeciesAccordion(); 
                parentFolderInputElement.value = ''; 

                if (groupedSpeciesData.length > 0) {
                    scientificNameInputElement.value = "All orchids";
                    dutchNameInputElement.value = "(Overview)";
                    parentFolderSelectionSection.style.display = 'none'; 
                    speciesSelectionSection.style.display = 'block';    
                    logDisplayArea.style.display = 'none';  

                    let allFilesForOverview = [];
                    groupedSpeciesData.forEach(genus => {
                        genus.speciesList.forEach(species => {
                            allFilesForOverview = allFilesForOverview.concat(species.filesInSubfolder);
                        });
                    });
                    await processFileList(allFilesForOverview, "All orchids (Overview)", true); 
                } else {
                    showToast("No valid species subfolders found in the selected parent folder.", "info");
                    parentFolderSelectionSection.style.display = 'block'; 
                    speciesSelectionSection.style.display = 'none';
                    if (isPanelOpen) { 
                        toggleSlidePanel(); 
                    }
                }
            });
            
            map.on('zoomend', reclusterAndDisplay);
            map.on('moveend', reclusterAndDisplay);

            function updateZoomLevel() {
                if (zoomLevelDisplayElement) {
                    zoomLevelDisplayElement.textContent = 'Zoom: ' + map.getZoom();
                }
            }
            map.on('zoomend', updateZoomLevel);
            updateZoomLevel(); 

            // Open panel on startup by calling the toggle function once
            toggleSlidePanel();

            const mapElement = document.getElementById('map'); 
            const resizeObserver = new ResizeObserver(() => { map.invalidateSize(); });
            resizeObserver.observe(mapContainerOuterElement); 
        }); 
    </script>
</body>
</html>
